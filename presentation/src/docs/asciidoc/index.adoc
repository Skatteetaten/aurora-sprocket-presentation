:customcss: css/custom.css

[state=title]
= Continuous deployment of docker images on Kubernetes that scale
Bjarte Stien Karlsen & Kristoffer Moberg Christensen
2019-09-14
:revnumber: {project-version}

[state=right-box]
== How do [.underline]#*YOU*# roll out critical security patches?
image::images/security-bug.jpg[canvas, size=cover]

[state=red-font]
== Agenda
* Who are we? 5 min
* Background 10 min
* Sprocket 15 min
* Use cases 10 min
* How can you adopt Sprocket? : 10 min
* How to expand on Sprocket? : 10 min

[state=red-font]
== Who are we?
* Bjarte Stien Karlsen, Architect & Developer in the Norwegian Tax Administration(NTA)
* Kristoffer Moberg Christensen, Trainee in NTA


[state=red-font]
== Background
 * Current solution based on polling the DockerRegistry
 ** Scheduled ImageStreams
 ** BuildTriggers on BaseImages and BuilderLogic
 * Current solution ties us to OpenShift

** TODO: lag et diagram som viser polling fra ImageStream og BuildTrigger

=== Problem #1: Performance
Polling for new changes to lots of images all the time does not scale

** TODO: Tall, logger. høre med Eivind/Siggen.

MaxScheduledImageImportsPerMinute=120
ScheduledImageImportMinimumIntervalSeconds=120


=== Problem #2: Race condition on multiple triggers
If a Pod has two containers and both have new versions who triggers first?

=== Problem #3: No flow control
Updating the base image/builder will fire every single build at the same time


=== Can OpenSource help?
* https://github.com/containrrr/watchtower and https://github.com/pyouroboros/ouroboros are both based on polling.
* It might be easier to tune the algorithm compared to ImageStreams.
* However the problem with throttling still exist.

=== What primities can help us here?
 * notifications from DockerRegistries
 * notifications from build pipelines

=== Introducing Sprocket
No OpenSource solution
[state=red-font]
== Sprocket
plantuml::sprocket.puml["sprocket", png]

=== Problems
 * What if event fails?
 * Need to monitor and have fallback mechanism. Poll
 * Mechanism to check if image is running the latest version?
 * Distribute event to multiple clusters


[.right]
image::images/FraggleRock-Sprocket.jpg,150, float="right"]

[.left]
* Currently running as a Pilot in our Platform
* Sprocket is named after the dog in Fraggle Rock


=== Sequence
 - listen to globalEventHook
 - filter out garbage events
 - parse event into a ImageChangeEvent
 - find related kubernetes resources
 - perform builds/deployments/imports

=== Video manus
 - 3 terminaler
 - topp bygg
 - venstre sprocket log
 - høyre: stern for apper

 * start bygg uten sprocket annotasjon
 * vis at det kommer sprocket event men ikke at det rulles ut noe

 * annoter app 1
 * start bygg, vis at det kommer
 * annoter app 2
 * start bygg, vis at begge kommer

[state=red-font]
=== How does it work?
** demo, video, asciicinema elns

* Show deployment
* Patch the deployment with the sprocket label
* Push an updated image
* See that it updates

* queries on labels in kubernetes is optimized
* a label can only be 63 characters and not contain special characters
* we sha1 the url to the tag and use that as the key

* annotate DC/Deployment/IS or create CRD for 1-many

=== How do you use Sprocket
 * a single trigger in a resource can use the `skatteetaten.no/sprocket` label

=== Plans
 * rate limit changes from a single source. If a ImageChangeEvent returns 2000 resource run 100 at a time and sleep between

[state=red-font]
=== Solution composition

* A server-side component that receive push events from a DockerRegistry

[state=red-font]
== Docker Registry

* Webhook pushes events to Sprocket
* Image

[state=red-font]
== Permissions

* Deployment

[state=red-font]
== Image Change

* Sprocket label on resources that wants updated images
* SHA1 hash of the image pull url
* Many-to-one semantics with CRD

==

[state=red-font]
== Usecases
How you can use Sprocket is correlated heavily on how you version your docker images. Does the version change if you change the way you build Docker Images or if the base image changes?

[state=red-font]
=== Our version strategy
https://skatteetaten.github.io/aurora/documentation/openshift/#image-versioning-strategy-the-auroraversion

* example from postgresql dockerhub. Screenshot?
* (Should be elaborated)

[state=red-font]
== Image change triggers
Pushing several tags for the same image allows user to decide when to update the deployment

[state=red-font]
== How can you adopt Sprocket?
* In your build pipeline push to a tag that is updated when there are new versions released on this release track.
* In your Deployments listen to this moveable tag and not an immutable tag
* label your Deployment with an sprocket label that is the hash of the URL to this tag.
* run sprocket configured to listen to Deployments in this namespace(or all namespaces)

[state=red-font]
== How to expand on Sprocket?
* Rate limit changes for one image
* Invalidate manifest cache
* support 1-many triggers via a CRD Sprocket.
* this will enable you to _not_ touch Deployment/ImageStream/DeploymentConfig resources. Only the CRD.
