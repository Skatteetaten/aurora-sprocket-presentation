

[state=title]
= Continuous deployment of docker images on Kubernetes that scale
Bjarte Stien Karlsen & Kristoffer Moberg Christensen
2019-09-14
:customcss: css/custom.css

:revnumber: {project-version}

[state=white-font]
== How do [.underline]#*YOU*# roll out critical security bugs?
image::images/security-bug.jpg[background, size=cover]


== Agenda
* Who are we?
* Background
* Sprocket
* Usecases
* How can you adopt Sprocket?
* How to expand on Sprocket?


== Who are we?
* Bjarte Stien Karlsen, Architect & Developer in The Norwegian Tax Administration(TNTA)
* Kristoffer Moberg Christensen, Trainee in TNTA

== Background
* Change in Base Images or builder logic = trigger all BuildConfigs simultaneously
* Time from image build to Deployment is too long (some cases 2-4 hours)

== Sprocket
image::images/FraggleRock-Sprocket.jpg[sprocket,150, float="right"]
* Currently running as a Pilot in our Plattform
* Sprocket is named after the dog in Fraggle rock


== How does it work?
* Show deployment
* Patch the deployment with the sprocket label
* Push an updated image
* See that it updates

== Solution composition
* Sprocket: A server-side component that receive push events from a DockerRegistry
 ** Sprockets needs to run with permissions to perform certain operations in your cluster.
* an sprocket label on the resources you want to have new images that sprocket will query against when it receives an push event
  ** Sprocket labels are sha1 hashes of the url where you pull the image from
  ** If you want to listen to more then one image change in a resource you can use a Sprocket CRD to get many-to-one semantics



== Usecases
How you can use Sprocket is correlated heavily on how you version your docker images. Does the version change if you change the way you build Docker Images or if the base image changes?

https://skatteetaten.github.io/aurora/documentation/openshift/#image-versioning-strategy-the-auroraversion

If you push tags when building your images like in the above documentation it can open lots of possibilities.


== How can you adopt Sprocket?
* In your build pipeline push to a tag that is updated when there are new versions released on this release track.
* In your Deployments listen to this moveable tag and not an immutable tag
* label your Deployment with an sprocket label that is the hash of the URL to this tag.
* run sprocket configured to listen to Depoyments in this namespace(or all namespaces)


== How to expand on Sprocket?
* Rate limit changes for one image
* Invalidate manifest cache